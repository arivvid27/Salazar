{% extends "base.html" %}

{% block title %}Scanning in Progress - Muninn{% endblock %}

{% block content %}
<div class="scan-status-container">
    <h1>Scanning in Progress</h1>
    
    <div class="scan-target">
        <h2>Target: <span class="url-text">{{ scan.target_url }}</span></h2>
    </div>
    
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        <div class="progress-text">
            <span class="scanning-text">Scanning...</span>
            <span id="progress-percentage">0%</span>
        </div>
    </div>
    
    <div class="scan-details">
        <div id="scan-stats">
            <div class="stat">
                <span class="stat-label">URLs Scanned:</span>
                <span id="urls-scanned" class="stat-value">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">XSS Results:</span>
                <span id="xss-results" class="stat-value">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">CSRF Results:</span>
                <span id="csrf-results" class="stat-value">0</span>
            </div>
        </div>
        
        <div class="current-activity">
            <h3>Current Activity</h3>
            <div id="activity-log">
                <div class="log-entry">Initializing scan...</div>
            </div>
        </div>
    </div>
    
    <div class="actions">
        <p>Please do not close this window. You will be redirected to the results page when the scan is complete.</p>
        <a href="{{ url_for('index') }}" class="btn btn-outline">Cancel Scan</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanId = '{{ scan.id }}';
    const activityLog = document.getElementById('activity-log');
    const progressFill = document.querySelector('.progress-fill');
    const progressPercentage = document.getElementById('progress-percentage');
    const urlsScanned = document.getElementById('urls-scanned');
    const xssResults = document.getElementById('xss-results');
    const csrfResults = document.getElementById('csrf-results');
    
    let checkInterval;
    let lastProgress = 0;
    
    function addLogEntry(message) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = message;
        activityLog.appendChild(entry);
        activityLog.scrollTop = activityLog.scrollHeight;
    }
    
    function updateProgress(progress) {
        progressFill.style.width = `${progress}%`;
        progressPercentage.textContent = `${progress}%`;
        
        if (progress > lastProgress) {
            lastProgress = progress;
        }
    }
    
    function checkScanStatus() {
        fetch(`/api/scan/${scanId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(checkInterval);
                    window.location.href = `/scan/${scanId}/results`;
                    return;
                }
                
                urlsScanned.textContent = data.progress.urls_scanned;
                xssResults.textContent = data.progress.xss_results;
                csrfResults.textContent = data.progress.csrf_results;
                
                let progress = 0;
                if (data.progress.urls_scanned > 0) {
                    const resultsCount = data.progress.xss_results + data.progress.csrf_results;
                    if (resultsCount > 0) {
                        progress = Math.min(90, Math.round((resultsCount / data.progress.urls_scanned) * 45) + 45);
                    } else {
                        progress = Math.min(45, Math.round(data.progress.urls_scanned * 5));
                    }
                } else {
                    progress = 5;
                }
                
                updateProgress(progress);
                
                if (progress <= 10 && lastProgress < 10) {
                    addLogEntry('Crawling target website...');
                } else if (progress <= 30 && lastProgress < 30) {
                    addLogEntry(`Discovered ${data.progress.urls_scanned} URLs for scanning.`);
                } else if (progress <= 50 && lastProgress < 50) {
                    addLogEntry('Analyzing pages for XSS vulnerabilities...');
                } else if (progress <= 70 && lastProgress < 70) {
                    addLogEntry('Analyzing forms for CSRF vulnerabilities...');
                } else if (progress <= 90 && lastProgress < 90) {
                    addLogEntry('AI is verifying potential vulnerabilities...');
                }
            })
            .catch(error => {
                console.error('Error checking scan status:', error);
                addLogEntry('Error checking scan status. Retrying...');
            });
    }
    
    addLogEntry('Starting scan...');
    updateProgress(5);
    
    checkInterval = setInterval(checkScanStatus, 2000);
    
    checkScanStatus();
});
</script>
{% endblock %}